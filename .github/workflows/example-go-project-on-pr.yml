name: example-go-project-on-pr

# Controls when the workflow will run
on:
  pull_request:
    branches: [ "main" ]
    paths:
      - 'example-go-project/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  get-image-names:
    runs-on: ubuntu-latest
    outputs:
      image_names: ${{ steps.get-image-names.outputs.image_names }}
    steps:
      - uses: actions/checkout@v3

      - name: get image names
        id: get-image-names
        working-directory: ./example-go-project/build/dockerfile
        run: |
          image_names='[ '
          for image_name in Dockerfile.*; do
            image_names+="${image_name##*.}, "
          done
          image_names="${image_names%??} ]"
          echo $image_names
          echo "image_names=$image_names" >> $GITHUB_OUTPUT

  build-and-push-images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ needs.get-image-names.outputs.image_names }}
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

      - name: Build the docker image
        working-directory: ./example-go-project
        run: docker build -t ${{secrets.DOCKERHUB_USERNAME}}/${{matrix.app}}:${GITHUB_SHA:7} -f build/dockerfile/Dockerfile.${{matrix.image}}

      - name: Push the image
        working-directory: ./example-go-project
        run: docker push ${{secrets.DOCKERHUB_USERNAME}}/${{matrix.image}}:${GITHUB_SHA:7}
